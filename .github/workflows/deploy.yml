name: CI/CD for Spring Boot

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
        run:
          working-directory: ./Backend
    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v1
      with:
        java-version: '17'

    # 테스트 무시하고 gradle 빌드
    - name: Build with Gradle (Skip Tests)
      run: ./gradlew build -x test  

    - name: Cache Gradle packages
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle
 
      
    # 여러개의 환경 변수를 .env 파일에 저장   
    - name: Set up environment variables
      run: |
          echo "DOCKE_HUB_PASSWORD=${{ secrets.DOCKE_HUB_PASSWORD }}" >> .env
          echo "DOCKE_HUB_USERNAME=${{ secrets.DOCKE_HUB_USERNAME }}" >> .env
          echo "EC2_INSTANCE_IPADDRESS= ${{ secrets.EC2_INSTANCE_IPADDRESS }}" >> .env
          echo "EC2_INSTANCE_PRIVATEKEY=${{ secrets.EC2_INSTANCE_PRIVATEKEY }}" >> .env
          echo "EC2_SERVER_USER=${{ secrets.EC2_SERVER_USER }}" >> .env
          echo "DOCKE_HUB_REPOSITORY=${{secrets.DOCKE_HUB_REPOSITORY}}" >> .env
        
    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKE_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKE_HUB_USERNAME }}" --password-stdin

    - name: Build Docker image
      run: docker build -t your_dockerhub_username/spring-boot-app:latest .

    - name: Push Docker image to Docker Hub
      run: docker push your_dockerhub_username/spring-boot-app:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
       host: ${{ secrets.EC2_INSTANCE_IPADDRESS }}
       username: ${{ secrets.EC2_SERVER_USER    }}
       key: ${{ secrets.EC2_INSTANCE_PRIVATEKEY }}
       script: |
          docker pull your_dockerhub_username/spring-boot-app:latest
          docker stop spring-boot-app || true
          docker rm spring-boot-app || true
          docker run -d -p 8080:8080 --name spring-boot-app your_dockerhub_username/spring-boot-app:latest

